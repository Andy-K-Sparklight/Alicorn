(()=>{"use strict";class e{}function t(){try{return unsafeWindow}catch{return window}}let n=null;const o=new Map;let i=0;async function r(e,...t){return await function(e,...t){const r=++i;return n?.send(JSON.stringify({eid:r,channel:e,args:t})),new Promise((e=>{o.set(r,e)}))}(e,...t)}class c extends e{execute(e,...n){t().invokeAlicorn=r}}function d(...e){try{unsafeWindow.showDialog(...e)}catch{window.showDialog(...e)}}function l(){return document.querySelector("tbody > tr:nth-child(1) > td.plc > div.pct > div > div.typeoption > table > tbody")?.innerHTML.includes("Mod类型")||!1}function s(){return document.querySelector("tbody > tr:nth-child(1) > td.plc > div.pct > div > div.typeoption > table > tbody > tr:nth-child(6) > td")?.innerHTML.split(/&nbsp;| /i)||[]}function a(){return document.querySelector("tbody > tr:nth-child(1) > td.plc > div.pct > div > div.typeoption > table > tbody > tr:nth-child(2) > td")?.innerHTML||""}class u extends e{execute(e,...n){!function(e){l()&&function(e){const n=s(),o=a(),i=e.querySelector("tbody > tr:nth-child(1) > td.plc > div.pct > div > div.typeoption > table > tbody > tr:nth-child(7) > td"),c=(i?.innerHTML||"Fabric").split(/&nbsp;| /i);if(i&&(i.childNodes.forEach((e=>{e.remove()})),c.map((t=>{if(t.trim().length>0){const n=e.createElement("span");return n.onclick=()=>{window.sessionStorage.setItem("selectedLoader",t.trim())},n.innerHTML=t,n}})).forEach((e=>{e&&i.append(e)}))),n.length>0&&o.length>0){const i=n.map((n=>{const i=e.createElement("span");return i.onclick=async()=>{const e=await async function(){const e=await r("GetAllContainers");return 0===e.length?"":1===e.length?e[0]:(d("你想安装到哪个容器中？单击以选择。<br/>"+e.map((e=>`<span onclick="window.dispatchEvent(new CustomEvent('selectContainer', {detail:'${e}'}));">${e}</span>`)).join("<br/>")+'<br/><i style="color:gray">是时候了！</i>',"notice","选择安装目标"),new Promise((e=>{t().addEventListener("selectContainer",(t=>{const n=String(t.detail);e(n)}))})))}();d("准备就绪，转到 Alicorn 按下安装按钮试试吧！","right"),await r("JumpTo",`/PffFront/${e}/${n}/${window.sessionStorage.getItem("selectedLoader")||"Fabric"}/${o}`,"PffFront")},i.innerHTML=n+" ",i})),c=e.querySelector("tbody > tr:nth-child(1) > td.plc > div.pct > div > div.typeoption > table > tbody > tr:nth-child(6) > td");c&&(c.childNodes.forEach((e=>{e.remove()})),i.forEach((e=>{c.append(e)})))}}(e)}(e)}}class p extends e{execute(e){e.querySelectorAll("a").forEach((e=>{e.target="_self"}))}}async function g(e,t,n){await r("JumpTo",`/ReadyToLaunch/${t}/${n}/${e}`,"ReadyToLaunch")}class v extends e{execute(e,...n){"服务器"===document.querySelector("tbody > tr:nth-child(1) > td.plc > div.pct > div > div.typeoption > table > caption")?.innerHTML&&function(){const e=document.getElementById("server_ip_menu");e&&(e.innerHTML='<span style="color:#df307f;"><b>在 Alicorn 中打开</b></span>');const n=document.getElementById("server_ip");n&&(n.onclick=async()=>{d('Starlight 正在收集必要信息，请稍等，马上就好……<br/><i style="color:gray">已经派出了 Spike，但他可能半路上遇到了 Rarity……</i>',"info","获取中……");const e=(n=document.getElementById("server_ip")?.innerText||"").includes(":")?n:n+":25565";var n;if(!await async function(e){return!!await r("TestServer",e)}(e)&&!await new Promise((e=>{d('Alicorn 报告此服务器不可达，无法连接。<br/>仍要尝试加入吗？<br/><i style="color:gray">Twilight 未能打开传送门</i>',"confirm","无法使用该服务器",(()=>{e(!0)}),void 0,(()=>{e(!1)}),"","仍要加入","好")})))return;const o=await async function(e){const t=await r("GetAllInstalledCores"),n=[];for(const[o,i]of Object.entries(t))for(const t of i){const i=await r("GetCoreInfo",o,t);e.includes(i.baseVersion)&&n.push(i)}return n}(function(){const e=document.querySelector("tbody > tr:nth-child(1) > td.plc > div.pct > div > div.typeoption > table > tbody > tr:nth-child(3) > td");return e?e.innerHTML.split(/&nbsp;| /i):[]}());if(0!==o.length){if(1===o.length)return d('准备就绪，请转到 Alicorn，你的游戏在那里等你。<br/><i style="color:gray">出发！</i>',"right","就绪"),void await g(e,o[0].container,o[0].id);t().addEventListener("selectCore",(async t=>{const n=t.detail;d('准备就绪，请转到 Alicorn，你的游戏在那里等你。<br/><i style="color:gray">出发！</i>',"right","就绪"),await g(e,n.container,n.id)})),o.length>1&&d(`Alicorn 报告有不止一个可以运行的核心，单击以选择你想要使用的。<br/><span style="cursor:pointer;">${o.map((e=>`<span onclick="window.dispatchEvent(new CustomEvent('selectCore', {detail:{id:'${e.id}', container:'${e.container}'}}));">${e.container}/${e.id}</span>`)).join("<br/>")}</span><br/><i style="color:gray">出发！</i>`,"notice","选择核心")}else d('Alicorn 报告没有可用的核心，将无法启动游戏。<br/>请试着安装一个在支持版本中指定的核心。<br/><i style="color:gray">这不是计划中的</i>',"alert","无可用核心")})}()}}class f extends e{execute(e,...n){e.body.insertAdjacentHTML("afterbegin",'<div id="node_warning" style=\'position: fixed;width: 100%;height: 30px;bottom: 0;left: 0;right: 0;text-align: center;display: none;background-color: red;z-index: 999\'><span style=\'font-family: "Microsoft YaHei UI Light", Tahoma, Verdana, sans-serif;font-size: 14px;height: 30px;display: inline;color: white\'>此页面启用了 Node.js 集成，可以直接访问您的计算机，请确保您信任该站点！(<span id="node_warning_timer">5</span>s)</div>'),t().reportNodeFunction=()=>{const t=e.getElementById("node_warning");t&&(t.style.display="unset")};let o=5;const i=setInterval((()=>{const t=e.getElementById("node_warning_timer");if(t&&(t.innerHTML=(--o).toString()),o<=0){const t=e.getElementById("node_warning");t&&(t.style.display="none"),clearInterval(i)}}),1e3),r=e.createElement("script");r.setAttribute("type","text/javascript"),r.innerText='console.log("Testing Node.js features...");try{if(require("electron")){window.reportNodeFunction();console.log("Node.js found! It should be used wisely.")}}catch{console.log("No Node.js found. Whew...");}',r.onload=()=>{r.parentNode?.removeChild(r)},e.head.appendChild(r)}}function h(){const e=document.querySelector("#footer > div.uix_extendedFooter > div > div > div:nth-child(4) > div > h3")?.innerHTML?.includes("X3.5");return void 0!==e&&e}class y extends class{async prerender(e,...t){}}{render(e){e.getElementById("debuginfo")?.insertAdjacentHTML("afterend","<span>Starlight Experimental 0.1</span>"),h()?(e.querySelector("#top > div.p-body > div.uix_sidebarNav > div.uix_sidebarNav__inner.uix_stickyBodyElement > div > ul")?.insertAdjacentHTML("beforeend",'<li class="uix_sidebarNavList__listItem"><div class="p-navEl"><div><a class="p-navEl-link p-navEl-link--splitMenu"><i class="fas fa-magic"></i><span>Starlight Powered</span></a></div></div></li>'),e.querySelector("#top > div.offCanvasMenu.offCanvasMenu--nav.js-headerOffCanvasMenu.is-active > div.offCanvasMenu-content > div.sidePanel.sidePanel--nav.sidePanel--visitor > div > div > div.js-offCanvasNavTarget > ul")?.insertAdjacentHTML("beforeend",'<li><div class="offCanvasMenu-linkHolder"><a class="offCanvasMenu-link"><span>Starlight Powered</span></a></div><ul class="offCanvasMenu-subList"></ul></li>')):e.getElementById("top_bar_links")?.insertAdjacentHTML("beforeend","<a>Starlight Powered</a>")}}console.log("Starlight started."),console.log("Starlight by Andy K Rarity Sparklight with ❤~");let b=0;document.addEventListener("DOMContentLoaded",(async()=>{if(1!==b){b=1,console.log("DOM is ready."),console.log("Attaching invocation messenger...");try{await(n?Promise.resolve():new Promise(((e,t)=>{n=new WebSocket("ws://localhost:16814/"),n.onerror=e=>{console.log(e),t()},n.onopen=()=>{console.log("OPENED: Starlight <============> Alicorn"),e()},n.onclose=()=>{console.log("CLOSED: Starlight <            > Alicorn")},n.onmessage=e=>{const t=JSON.parse(String(e.data));if("number"==typeof t.eid){const e=o.get(t.eid);o.delete(t.eid),"function"==typeof e&&e(t.value)}}}))),console.log("Alicorn Launcher found! Have fun!"),console.log("Setting invoke module..."),(new c).execute(document)}catch{console.log("Alicorn Launcher not found! Starlight's features will be limited."),console.log("Just start your Alicorn and Starlight should work fine!")}console.log("Executing Node.js warning module..."),(new f).execute(document),"www.mcbbs.net"===t().location.host&&(console.log("MCBBS detected, running deobf..."),(new p).execute(document),function(){if(h()){console.log("V3 UI detected.");const e=document.querySelector("#footer > div.uix_extendedFooter > div > div > div:nth-child(4) > div");e&&(e.id="debuginfo"),console.log("Patched ID: debuginfo")}else{console.log("V2 UI detected.");const e=document.querySelector("#toptb > div > div.z.light");e&&(e.id="top_bar_links"),console.log("Patched ID: top_bar_links")}}(),console.log("Deobf completed, rendering."),(new y).render(document),console.log("Loading module JoinServer..."),(new v).execute(document),console.log("Loading module AddMod..."),(new u).execute(document))}}))})();