"use strict";const{Headers,HeadersList,fill}=require("./headers"),{extractBody,cloneBody,mixinBody}=require("./body"),util=require("../core/util"),{kEnumerableProperty}=util,{responseURL,isValidReasonPhrase,toUSVString}=require("./util"),{redirectStatus,nullBodyStatus,forbiddenHeaderNames}=require("./constants"),{kState,kHeaders,kGuard,kRealm}=require("./symbols"),{kHeadersList}=require("../core/symbols"),assert=require("assert");class Response{static error(){const e={settingsObject:{}},t=new Response;return t[kState]=makeNetworkError(),t[kRealm]=e,t[kHeaders][kHeadersList]=t[kState].headersList,t[kHeaders][kGuard]="immutable",t[kHeaders][kRealm]=e,t}static redirect(...e){const t={settingsObject:{}};if(e.length<1)throw new TypeError(`Failed to execute 'redirect' on 'Response': 1 argument required, but only ${e.length} present.`);const s=e.length>=2?e[1]:302,r=toUSVString(e[0]);let n;try{n=new URL(r)}catch(e){throw Object.assign(new TypeError("Failed to parse URL from "+r),{cause:e})}if(!redirectStatus.includes(s))throw new RangeError("Invalid status code");const a=new Response;a[kRealm]=t,a[kHeaders][kGuard]="immutable",a[kHeaders][kRealm]=t,a[kState].status=s;const o=n.toString();return a[kState].headersList.push("location",o),a}constructor(...e){if(e.length>=1&&"object"!=typeof e[1]&&void 0!==e[1])throw new TypeError("Failed to construct 'Request': cannot convert to dictionary.");const t=e.length>=1?e[0]:null,s=e.length>=2?e[1]??{}:{};if(this[kRealm]={settingsObject:{}},"status"in s&&void 0!==s.status){if(!Number.isFinite(s.status))throw new TypeError;if(s.status<200||s.status>599)throw new RangeError(`Failed to construct 'Response': The status provided (${s.status}) is outside the range [200, 599].`)}if("statusText"in s&&void 0!==s.statusText&&!isValidReasonPhrase(String(s.statusText)))throw new TypeError("Invalid statusText");if(this[kState]=makeResponse({}),this[kHeaders]=new Headers,this[kHeaders][kGuard]="response",this[kHeaders][kHeadersList]=this[kState].headersList,this[kHeaders][kRealm]=this[kRealm],"status"in s&&void 0!==s.status&&(this[kState].status=s.status),"statusText"in s&&void 0!==s.statusText&&(this[kState].statusText=String(s.statusText)),"headers"in s&&fill(this[kState].headersList,s.headers),null!=t){if(nullBodyStatus.includes(s.status))throw new TypeError("Response with null body status cannot have body");const[e,r]=extractBody(t);this[kState].body=e,r&&!this.headers.has("content-type")&&this.headers.set("content-type",r)}}get[Symbol.toStringTag](){if(!(this instanceof Response))throw new TypeError("Illegal invocation");return this.constructor.name}get type(){if(!(this instanceof Response))throw new TypeError("Illegal invocation");return this[kState].type}get url(){if(!(this instanceof Response))throw new TypeError("Illegal invocation");let e=responseURL(this[kState]);return null==e?"":(e.hash&&(e=new URL(e),e.hash=""),e.toString())}get redirected(){if(!(this instanceof Response))throw new TypeError("Illegal invocation");return this[kState].urlList.length>1}get status(){if(!(this instanceof Response))throw new TypeError("Illegal invocation");return this[kState].status}get ok(){if(!(this instanceof Response))throw new TypeError("Illegal invocation");return this[kState].status>=200&&this[kState].status<=299}get statusText(){if(!(this instanceof Response))throw new TypeError("Illegal invocation");return this[kState].statusText}get headers(){if(!(this instanceof Response))throw new TypeError("Illegal invocation");return this[kHeaders]}clone(){if(!(this instanceof Response))throw new TypeError("Illegal invocation");if(this.bodyUsed||this.body&&this.body.locked)throw new TypeError;const e=cloneResponse(this[kState]),t=new Response;return t[kState]=e,t[kRealm]=this[kRealm],t[kHeaders][kHeadersList]=e.headersList,t[kHeaders][kGuard]=this[kHeaders][kGuard],t[kHeaders][kRealm]=this[kHeaders][kRealm],t}}function cloneResponse(e){if(e.internalResponse)return filterResponse(cloneResponse(e.internalResponse),e.type);const t=makeResponse({...e,body:null});return null!==e.body&&(t.body=cloneBody(e.body)),t}function makeResponse(e){return{internalResponse:null,aborted:!1,rangeRequested:!1,timingAllowPassed:!1,type:"default",status:200,timingInfo:null,cacheState:"",statusText:"",...e,headersList:e.headersList?new HeadersList(...e.headersList):new HeadersList,urlList:e.urlList?[...e.urlList]:[]}}function makeNetworkError(e){return makeResponse({type:"error",status:0,error:e instanceof Error?e:new Error(e?String(e):e),aborted:e&&"AbortError"===e.name})}function filterResponse(e,t){if("basic"===t){const t=[];for(let s=0;s<e.headersList.length;s+=2)forbiddenHeaderNames.includes(e.headersList[s])||t.push(e.headersList[s+0],e.headersList[s+1]);return makeResponse({...e,internalResponse:e,headersList:new HeadersList(...t),type:"basic"})}return"cors"===t?makeResponse({...e,internalResponse:e,type:"cors"}):"opaque"===t?makeResponse({...e,internalResponse:e,type:"opaque",urlList:[],status:0,statusText:"",body:null}):"opaqueredirect"===t?makeResponse({...e,internalResponse:e,type:"opaqueredirect",status:0,statusText:"",headersList:new HeadersList,body:null}):void assert(!1)}mixinBody(Response.prototype),Object.defineProperties(Response.prototype,{type:kEnumerableProperty,url:kEnumerableProperty,status:kEnumerableProperty,ok:kEnumerableProperty,redirected:kEnumerableProperty,statusText:kEnumerableProperty,headers:kEnumerableProperty,clone:kEnumerableProperty}),module.exports={makeNetworkError,makeResponse,filterResponse,Response};