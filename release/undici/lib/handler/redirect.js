"use strict";const util=require("../core/util"),{kBodyUsed}=require("../core/symbols"),assert=require("assert"),{InvalidArgumentError}=require("../core/errors"),EE=require("events"),redirectableStatusCodes=[300,301,302,303,307,308],kBody=Symbol("body");class BodyAsyncIterable{constructor(t){this[kBody]=t,this[kBodyUsed]=!1}async*[Symbol.asyncIterator](){assert(!this[kBodyUsed],"disturbed"),this[kBodyUsed]=!0,yield*this[kBody]}}class RedirectHandler{constructor(t,o,e,s){if(null!=o&&(!Number.isInteger(o)||o<0))throw new InvalidArgumentError("maxRedirections must be a positive number");util.validateHandler(s,e.method,e.upgrade),this.dispatcher=t,this.location=null,this.abort=null,this.opts={...e,maxRedirections:0},this.maxRedirections=o,this.handler=s,this.history=[],util.isStream(this.opts.body)?(0===util.bodyLength(this.opts.body)&&this.opts.body.on("data",(function(){assert(!1)})),"boolean"!=typeof this.opts.body.readableDidRead&&(this.opts.body[kBodyUsed]=!1,EE.prototype.on.call(this.opts.body,"data",(function(){this[kBodyUsed]=!0})))):(this.opts.body&&"function"==typeof this.opts.body.pipeTo||this.opts.body&&"string"!=typeof this.opts.body&&!ArrayBuffer.isView(this.opts.body)&&util.isIterable(this.opts.body))&&(this.opts.body=new BodyAsyncIterable(this.opts.body))}onConnect(t){this.abort=t,this.handler.onConnect(t,{history:this.history})}onUpgrade(t,o,e){this.handler.onUpgrade(t,o,e)}onError(t){this.handler.onError(t)}onHeaders(t,o,e,s){if(this.location=this.history.length>=this.maxRedirections||util.isDisturbed(this.opts.body)?null:parseLocation(t,o),this.opts.origin&&this.history.push(new URL(this.opts.path,this.opts.origin)),!this.location)return this.handler.onHeaders(t,o,e,s);const{origin:i,pathname:r,search:n}=util.parseURL(new URL(this.location,this.opts.origin)),a=n?`${r}${n}`:r;this.opts.headers=cleanRequestHeaders(this.opts.headers,303===t,this.opts.origin!==i),this.opts.path=a,this.opts.origin=i,this.opts.maxRedirections=0,303===t&&"HEAD"!==this.opts.method&&(this.opts.method="GET",this.opts.body=null)}onData(t){if(!this.location)return this.handler.onData(t)}onComplete(t){this.location?(this.location=null,this.abort=null,this.dispatcher.dispatch(this.opts,this)):this.handler.onComplete(t)}onBodySent(t){this.handler.onBodySent&&this.handler.onBodySent(t)}}function parseLocation(t,o){if(-1===redirectableStatusCodes.indexOf(t))return null;for(let t=0;t<o.length;t+=2)if("location"===o[t].toString().toLowerCase())return o[t+1]}function shouldRemoveHeader(t,o,e){return 4===t.length&&"host"===t.toString().toLowerCase()||o&&0===t.toString().toLowerCase().indexOf("content-")||e&&13===t.length&&"authorization"===t.toString().toLowerCase()}function cleanRequestHeaders(t,o,e){const s=[];if(Array.isArray(t))for(let i=0;i<t.length;i+=2)shouldRemoveHeader(t[i],o,e)||s.push(t[i],t[i+1]);else if(t&&"object"==typeof t)for(const i of Object.keys(t))shouldRemoveHeader(i,o,e)||s.push(i,t[i]);else assert(null==t,"headers must be an object or an array");return s}module.exports=RedirectHandler;